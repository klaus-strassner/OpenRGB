#include "CherryController.h"
#include <thread>
#include <iostream>
#include <vector>
#include <string>
#include "studio.pb.h"
#include <iomanip>


static uint8_t bin[] = {
    0xab, 0x0a, 0x83, 0x07, 0x08, 0x0a, 0x2a, 0xfe, 0x06, 0x32, 0xfb, 0x06, 0x12, 0xf8, 0x06, 0x0a, 
    0x08, 0x46, 0x61, 0x76, 0x6f, 0x6e, 0x69, 0x75, 0x73, 0x12, 0x06, 0x08, 0xc8, 0x01, 0x10, 0xc8, 
    0x01, 0x12, 0x09, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xc8, 0x01, 0x12, 0x09, 0x08, 0xc8, 
    0x01, 0x10, 0xc8, 0x01, 0x18, 0x90, 0x03, 0x12, 0x09, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 
    0xd8, 0x04, 0x12, 0x09, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xa0, 0x06, 0x12, 0x09, 0x08, 
    0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xe8, 0x07, 0x12, 0x09, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 
    0x18, 0xb0, 0x09, 0x12, 0x09, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xf8, 0x0a, 0x12, 0x09, 
    0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xc0, 0x0c, 0x12, 0x09, 0x08, 0xc8, 0x01, 0x10, 0xc8, 
    0x01, 0x18, 0x88, 0x0e, 0x12, 0x09, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xd0, 0x0f, 0x12, 
    0x09, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0x98, 0x11, 0x12, 0x09, 0x08, 0xc8, 0x01, 0x10, 
    0xc8, 0x01, 0x18, 0xe0, 0x12, 0x12, 0x09, 0x08, 0x90, 0x03, 0x10, 0xc8, 0x01, 0x18, 0xa8, 0x14, 
    0x12, 0x09, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xf4, 0x17, 0x12, 0x09, 0x08, 0xac, 0xac, 
    0x02, 0x10, 0xc8, 0x01, 0x20, 0xc8, 0x01, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 
    0xac, 0xac, 0x02, 0x20, 0xc8, 0x01, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xf4, 
    0x03, 0x20, 0xc8, 0x01, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xbc, 0x05, 0x20, 
    0xc8, 0x01, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0x84, 0x07, 0x20, 0xc8, 0x01, 
    0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xcc, 0x08, 0x20, 0xc8, 0x01, 0x12, 0x0c, 
    0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0x94, 0x0a, 0x20, 0xc8, 0x01, 0x12, 0x0c, 0x08, 0xc8, 
    0x01, 0x10, 0xc8, 0x01, 0x18, 0xdc, 0x0b, 0x20, 0xc8, 0x01, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 
    0xc8, 0x01, 0x18, 0xa4, 0x0d, 0x20, 0xc8, 0x01, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 
    0x18, 0xec, 0x0e, 0x20, 0xc8, 0x01, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xb4, 
    0x10, 0x20, 0xc8, 0x01, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xfc, 0x11, 0x20, 
    0xc8, 0x01, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xc4, 0x13, 0x20, 0xc8, 0x01, 
    0x12, 0x0c, 0x08, 0xac, 0xac, 0x02, 0x10, 0xc8, 0x01, 0x18, 0x8c, 0x15, 0x20, 0xc8, 0x01, 0x12, 
    0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xf4, 0x17, 0x20, 0xc8, 0x01, 0x12, 0x09, 0x08, 
    0xde, 0x02, 0x10, 0xc8, 0x01, 0x20, 0x90, 0x03, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 
    0x18, 0xde, 0x02, 0x20, 0x90, 0x03, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xa6, 
    0x04, 0x20, 0x90, 0x03, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xee, 0x05, 0x20, 
    0x90, 0x03, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xb6, 0x07, 0x20, 0x90, 0x03, 
    0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xfe, 0x08, 0x20, 0x90, 0x03, 0x12, 0x0c, 
    0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xc6, 0x0a, 0x20, 0x90, 0x03, 0x12, 0x0c, 0x08, 0xc8, 
    0x01, 0x10, 0xc8, 0x01, 0x18, 0x8e, 0x0c, 0x20, 0x90, 0x03, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 
    0xc8, 0x01, 0x18, 0xd6, 0x0d, 0x20, 0x90, 0x03, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 
    0x18, 0x9e, 0x0f, 0x20, 0x90, 0x03, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xe6, 
    0x10, 0x20, 0x90, 0x03, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xae, 0x12, 0x20, 
    0x90, 0x03, 0x12, 0x0c, 0x08, 0xc2, 0x03, 0x10, 0xc8, 0x01, 0x18, 0xf6, 0x13, 0x20, 0x90, 0x03, 
    0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xf4, 0x17, 0x20, 0x90, 0x03, 0x12, 0x09, 
    0x08, 0xc2, 0x03, 0x10, 0xc8, 0x01, 0x20, 0xd8, 0x04, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 
    0x01, 0x18, 0xc2, 0x03, 0x20, 0xd8, 0x04, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 
    0x8a, 0x05, 0x20, 0xd8, 0x04, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xd2, 0x06, 
    0x20, 0xd8, 0x04, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0x9a, 0x08, 0x20, 0xd8, 
    0x04, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xe2, 0x09, 0x20, 0xd8, 0x04, 0x12, 
    0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xaa, 0x0b, 0x20, 0xd8, 0x04, 0x12, 0x0c, 0x08, 
    0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xf2, 0x0c, 0x20, 0xd8, 0x04, 0x12, 0x0c, 0x08, 0xc8, 0x01, 
    0x10, 0xc8, 0x01, 0x18, 0xba, 0x0e, 0x20, 0xd8, 0x04, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 
    0x01, 0x18, 0x82, 0x10, 0x20, 0xd8, 0x04, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 
    0xca, 0x11, 0x20, 0xd8, 0x04, 0x12, 0x0c, 0x08, 0xde, 0x02, 0x10, 0xc8, 0x01, 0x18, 0x92, 0x13, 
    0x20, 0xd8, 0x04, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xf0, 0x15, 0x20, 0xd8, 
    0x04, 0x12, 0x09, 0x08, 0xfa, 0x01, 0x10, 0xc8, 0x01, 0x20, 0xa0, 0x06, 0x12, 0x0c, 0x08, 0xfa, 
    0x01, 0x10, 0xc8, 0x01, 0x18, 0xfa, 0x01, 0x20, 0xa0, 0x06, 0x12, 0x0c, 0x08, 0xfa, 0x01, 0x10, 
    0xc8, 0x01, 0x18, 0xf4, 0x03, 0x20, 0xa0, 0x06, 0x12, 0x0c, 0x08, 0xe2, 0x09, 0x10, 0xc8, 0x01, 
    0x18, 0xee, 0x05, 0x20, 0xa0, 0x06, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xd0, 
    0x0f, 0x20, 0xa0, 0x06, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0x98, 0x11, 0x20, 
    0xa0, 0x06, 0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xe0, 0x12, 0x20, 0xa0, 0x06, 
    0x12, 0x0c, 0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xa8, 0x14, 0x20, 0xa0, 0x06, 0x12, 0x0c, 
    0x08, 0xc8, 0x01, 0x10, 0xc8, 0x01, 0x18, 0xf0, 0x15, 0x20, 0xa0, 0x06, 0x12, 0x0c, 0x08, 0xc8, 
    0x01, 0x10, 0xc8, 0x01, 0x18, 0xb8, 0x17, 0x20, 0xa0, 0x06, 0xad
};

static uint8_t bin2[] = {
    0xAB, 0x08, 0x0a, 0x2a, 0x24, 0x32, 0x22, 0x08, 0x00, 0x12, 0x1e, 0x0a, 0x08, 0x46, 0x61, 0x76, 0x6f, 0x6e, 0x69, 0x75, 0x73, 0x12, 0x12, 0x08,
    0xac, 0xac, 0x02, 0x10, 0xc8, 0x01, 0x18, 0x00, 0x20, 0xc8, 0x01, 0x28, 0x00, 0x30, 0x00, 0x38, 0x00, 0xAD
};

// 080a2a2332210800121d0a084661766f6e697573121108ac0210c801180020c801280030003800
// 080a2a2432220800121e0a084661766f6e697573121208acac0210c801180020c801280030003800
// 080a2a2432220800121e0a084661766f6e697573121208aaac0210c801180020c801280030003800

CherryController::CherryController(const std::string &portName)
: requestId{0}, portName{portName}, serialPort(portName.c_str(), 0)
{
    serialPort.serial_set_dtr(false);
}

CherryController::~CherryController() {
    serialPort.serial_set_dtr(true);
}

std::string CherryController::GetLocation() {
    return portName;
}


size_t CherryController::NewId() {
    return ++requestId;
}

zmk::studio::Response CherryController::SendRecv(zmk::studio::Request request) {
    std::string payload;
    size_t request_id = NewId();
    request.set_request_id(request_id);

    request.SerializeToString(&payload);

    std::vector<uint8_t> txBuffer;
    txBuffer.reserve(payload.size() + 2);
    txBuffer.push_back(START_DELIMITER);
    txBuffer.insert(txBuffer.end(), payload.begin(), payload.end());
    txBuffer.push_back(END_DELIMITER);

    serialPort.serial_flush_tx();
    serialPort.serial_write(reinterpret_cast<char*>(txBuffer.data()), txBuffer.size());

    std::this_thread::sleep_for(std::chrono::milliseconds(500));

    size_t bytesRead = 0;
    uint8_t rxBuffer[4096];
    zmk::studio::Response response;

    bytesRead = serialPort.serial_read(reinterpret_cast<char*>(rxBuffer), sizeof(rxBuffer));

    // bool read = true;
    // while(read) {
    //     bytesRead += serialPort.serial_read(reinterpret_cast<char*>(rxBuffer + bytesRead), sizeof(rxBuffer) - bytesRead);
    //     if(bytesRead > 0) 
    //         if(rxBuffer[bytesRead - 1] == 0xAD)
    //             read = false;
    // }
    
    std::cout << "Bytes Read: " << std::dec << bytesRead << std::endl;

    for (size_t i = 0; i < bytesRead; ++i) {
        std::cout << std::hex << std::setw(2) << std::setfill('0') 
            << static_cast<int>(static_cast<unsigned char>(rxBuffer[i])) << " ";
    }
    std::cout << std::endl;
    
    if(bytesRead == 0 || rxBuffer[bytesRead-1] != END_DELIMITER || rxBuffer[0] != START_DELIMITER) {
        std::cout << "WRONG MESSAGE FORMAT" << std::endl;
        return response;
    }

    // todo ?
    // check request id


   // response.ParseFromArray(&bin[1], sizeof(bin) - 2);

//    if(response.ParseFromArray(&rxBuffer[1], bytesRead - 2))
    if(response.ParseFromArray(&bin2[1], sizeof(bin[2])))
        std::cout << "success parsing" << std::endl;
    else
        std::cout << "error parsing: " << response.InitializationErrorString() << std::endl;
    
    response.PrintDebugString();

    return response;
}

zmk::core::GetDeviceInfoResponse CherryController::GetDeviceInfo() {
    zmk::studio::Request request;
    request.mutable_core()
        ->set_get_device_info(true);

    zmk::studio::Response response = SendRecv(request);
    return response.request_response()
        .core()
        .get_device_info();
}

zmk::led_settings::LedEffectsNodesInfo CherryController::GetEffects() {
    zmk::studio::Request request;
    request.mutable_led_settings()
        ->mutable_led_settings_get_info()
        ->set_effects(true);

    zmk::studio::Response response = SendRecv(request);
    return response.request_response()
        .led_settings()
        .led_settings_get_info()
        .effects_data();
}

zmk::led_settings::LedSettingsNodesInfo CherryController::GetSettings() {
    zmk::studio::Request request;
    request.mutable_led_settings()
        ->mutable_led_settings_get_info()
        ->set_settings(true);

    zmk::studio::Response response = SendRecv(request);
    return response.request_response()
        .led_settings()
        .led_settings_get_info()
        .settings_data();
}

zmk::led_settings::LedSettingsValues CherryController::GetSettingsValues(uint32_t studioId) {
    zmk::studio::Request request;
    request.mutable_led_settings()
        ->mutable_led_settings_get_values()
        ->set_settings_id(studioId);

    zmk::studio::Response response = SendRecv(request);
    return response.request_response()
        .led_settings()
        .led_settings_get_values()
        .values();
}

zmk::behaviors::GetBehaviorDetailsResponse CherryController::GetBehaviorDetail(uint32_t behaviorId) {
    zmk::studio::Request request;
    request.mutable_behaviors()
        ->mutable_get_behavior_details()
        ->set_behavior_id(behaviorId);

    zmk::studio::Response response = SendRecv(request);
    return response.request_response()
        .behaviors()
        .get_behavior_details();
}

zmk::keymap::PhysicalLayouts CherryController::GetPhysicalLayouts() {
    zmk::studio::Request request;
    request.mutable_keymap()
    ->set_get_physical_layouts(true);

    zmk::studio::Response response = SendRecv(request);
    return response.request_response()
        .keymap()
        .get_physical_layouts();
}


zmk::keymap::Keymap CherryController::GetKeymap() {
    zmk::studio::Request request;
    request.mutable_keymap()
    ->set_get_keymap(true);

    zmk::studio::Response response = SendRecv(request);
    return response.request_response()
        .keymap()
        .get_keymap();
}